<!DOCTYPE html>
<html>
<head>
    <title>Map - OpenLayers</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.0.0/ol.css">
    <style>
        body { margin: 0; padding: 0; }
        #mapDiv { width: 100%; height: 100vh; background-color: #f0f0f0; }
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px; /* Will be adjusted by OpenLayers */
            min-width: 180px;
            transform: translateX(-50%); /* Helps in centering if left is set to 50% of marker */
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 50%;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 50%;
            margin-left: -11px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
            color: #333; /* Make closer more visible */
        }
        .ol-popup-closer:after {
            content: "✖";
        }
        #popup-content {
            font-size: 14px;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="mapDiv"></div>
    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v9.0.0/dist/ol.js"></script>
    <script>
        // Script chính để khởi tạo và quản lý bản đồ OpenLayers,
        // bao gồm hiển thị marker (thông qua các hàm được gọi từ Java),
        // xử lý popup và giao tiếp với Java.

        let mapInstance = null; // Đối tượng bản đồ OpenLayers chính
        let markerLayer = null; // Layer chứa các điểm đánh dấu (marker) trên bản đồ
        let routeLayer = null;  // Layer hiển thị tuyến đường được vẽ (quản lý bởi Java)
        let popupOverlay = null; // Overlay để hiển thị thông tin chi tiết (popup) khi nhấp vào marker
        let popupContentElement = null; // Phần tử DOM chứa nội dung của popup
        let popupCloserElement = null; // Phần tử DOM để đóng popup
        const hanoiCoords = ol.proj.fromLonLat([105.8342, 21.0278]); // Tọa độ trung tâm mặc định: Hà Nội
        // window.MAPTILER_API_KEY sẽ được inject bởi Java (được Java nạp vào)

        // Đảm bảo đối tượng javaConnector (cầu nối với Java) đã sẵn sàng trước khi thực hiện callback.
        // Hàm này sẽ liên tục kiểm tra sự tồn tại của window.javaConnector sau mỗi 100ms.
        function whenJavaConnectorReady(callback) {
            if (window.javaConnector) {
                callback();
            } else {
                console.log('Waiting for javaConnector...'); // Log trạng thái: Đang chờ javaConnector
                setTimeout(() => whenJavaConnectorReady(callback), 100);
            }
        }

        // Khởi tạo bản đồ OpenLayers với API key được cung cấp.
        // Nếu API key không có hoặc có lỗi, bản đồ sẽ sử dụng OpenStreetMap làm nguồn dữ liệu dự phòng.
        // Hàm này thường được gọi từ Java sau khi MAPTILER_API_KEY đã được nạp vào window.
        function initializeMapWithApiKey(useFallback = false) {
            console.log('map.html: initializeMapWithApiKey called.'); // Log: Hàm initializeMapWithApiKey được gọi
            if (mapInstance) { // Nếu bản đồ đã được khởi tạo, không thực hiện lại
                console.log('Map already initialized.'); // Log: Bản đồ đã được khởi tạo
                return;
            }

            const apiKey = window.MAPTILER_API_KEY;
            let tileSource; // Nguồn dữ liệu cho lớp Tile (bản đồ nền)

            if (!useFallback && apiKey) {
                console.log('Using MapTiler Outdoor map with API key.'); // Log: Sử dụng bản đồ MapTiler Outdoor với API key
                tileSource = new ol.source.XYZ({
                    url: `https://api.maptiler.com/maps/outdoor-v2/{z}/{x}/{y}.png?key=${apiKey}`,
                    attributions: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
                    tileSize: 512 // MapTiler thường dùng tileSize 512 cho một số style nhất định
                });
            } else { // Trường hợp không có API key hoặc yêu cầu sử dụng fallback
                if (useFallback) {
                    console.warn('MapTiler API Key not available or error, falling back to OpenStreetMap.'); // Cảnh báo: API Key MapTiler không có hoặc lỗi, chuyển sang OSM
                } else if (!apiKey) {
                     console.warn('MapTiler API Key not provided by Java, falling back to OpenStreetMap.'); // Cảnh báo: API Key MapTiler không được Java cung cấp, chuyển sang OSM
                }
                tileSource = new ol.source.OSM(); // Sử dụng OpenStreetMap làm nguồn dự phòng
            }

            // Lấy các phần tử DOM cho popup
            const popupContainer = document.getElementById('popup');
            popupContentElement = document.getElementById('popup-content');
            popupCloserElement = document.getElementById('popup-closer');

            // Tạo đối tượng Overlay cho popup
            popupOverlay = new ol.Overlay({
                element: popupContainer, // Phần tử HTML của popup
                autoPan: { // Tự động di chuyển bản đồ để popup hiển thị đầy đủ
                    animation: {
                        duration: 250, // Thời gian animation (ms)
                    },
                },
            });

            // Xử lý sự kiện đóng popup
            popupCloserElement.onclick = function() {
                popupOverlay.setPosition(undefined); // Ẩn popup
                popupCloserElement.blur(); // Bỏ focus khỏi nút đóng
                return false;
            };

            // Khởi tạo Layer chứa các điểm đánh dấu (marker)
            markerLayer = new ol.layer.Vector({
                source: new ol.source.Vector(), // Nguồn dữ liệu vector rỗng ban đầu
                style: new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 1], // Điểm neo của icon (0.5, 1) là ở giữa cạnh dưới
                        src: 'icons/custom_marker.png', // Đường dẫn tới file ảnh marker tùy chỉnh
                        scale: 0.5 // Tỷ lệ thu phóng icon (0.5 = 50% kích thước gốc)
                        // Có thể cần điều chỉnh anchor tùy theo hình dạng của icon
                    })
                })
            });

            // Khởi tạo Layer hiển thị tuyến đường
            routeLayer = new ol.layer.Vector({
                source: new ol.source.Vector(), // Nguồn dữ liệu vector rỗng ban đầu
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({ // Style cho đường vẽ
                        color: 'blue', // Màu đường
                        width: 3       // Độ rộng đường
                    })
                })
            });

            // Khởi tạo đối tượng bản đồ chính (mapInstance)
            mapInstance = new ol.Map({
                target: 'mapDiv', // ID của thẻ div chứa bản đồ
                layers: [ // Danh sách các layer trên bản đồ
                    new ol.layer.Tile({ source: tileSource }), // Layer bản đồ nền
                    markerLayer, // Layer chứa marker
                    routeLayer   // Layer chứa tuyến đường
                ],
                overlays: [popupOverlay], // Thêm overlay của popup vào bản đồ
                view: new ol.View({ // Cấu hình khung nhìn ban đầu của bản đồ
                    center: hanoiCoords, // Tâm bản đồ
                    zoom: 6              // Mức phóng đại ban đầu
                })
            });

            // Xử lý sự kiện nhấp chuột trên bản đồ
            mapInstance.on('click', function(event) {
                // Kiểm tra xem có feature (marker) nào tại vị trí nhấp chuột không
                const feature = mapInstance.forEachFeatureAtPixel(event.pixel, 
                    function(featureCandidate, layerCandidate) { 
                    // Đảm bảo feature này thuộc markerLayer và có thuộc tính 'name' (để phân biệt với các feature khác như đường route)
                    if (layerCandidate === markerLayer && featureCandidate.get('name')) {
                        return featureCandidate; // Trả về marker nếu tìm thấy
                    }
                    return undefined; // Bỏ qua nếu không phải marker mong muốn
                });

                if (feature) { // Nếu nhấp vào một marker
                    const coordinates = feature.getGeometry().getCoordinates(); // Lấy tọa độ của marker
                    popupOverlay.setPosition(coordinates); // Hiển thị popup tại tọa độ marker
                    // Tạo nội dung cho popup
                    let content = '<b>' + feature.get('name') + '</b>';
                    const description = feature.get('description');
                    if (description && description.trim() !== '') {
                        content += '<br>' + description;
                    }
                    popupContentElement.innerHTML = content; // Gán nội dung vào popup
                } else { // Nếu nhấp vào bản đồ (không phải marker)
                    popupOverlay.setPosition(undefined); // Ẩn popup nếu đang hiển thị
                    popupCloserElement.blur();

                    // Logic ban đầu: gửi tọa độ điểm vừa nhấp về Java để xử lý (ví dụ: thêm điểm mới)
                    const clickedCoords = event.coordinate; // Tọa độ (dạng OpenLayers) của điểm vừa nhấp
                    const lonLatCoords = ol.proj.toLonLat(clickedCoords); // Chuyển đổi sang LonLat
                    const lat = lonLatCoords[1];
                    const lng = lonLatCoords[0];
                    
                    // Gọi hàm của Java để xử lý việc nhấp chuột lên bản đồ
                    whenJavaConnectorReady(() => {
                        if (window.javaConnector && typeof window.javaConnector.handleMapClick === 'function') {
                            window.javaConnector.handleMapClick(lat, lng);
                        } else {
                            console.error('javaConnector.handleMapClick is not available.');
                        }
                    });
                }
            });
            console.log('map.html: OpenLayers map initialized with new base layer and popup.'); // Log: Bản đồ OpenLayers đã được khởi tạo
        }

        // Thêm một điểm đánh dấu (marker) mới vào bản đồ.
        // Hàm này được gọi từ Java.
        // Tham số: lng (kinh độ), lat (vĩ độ), name (tên địa điểm), description (mô tả).
        function addMapMarker(lng, lat, name, description) {
            if (!mapInstance || !markerLayer) {
                console.error("Map or marker layer not initialized. Cannot add marker.");
                return;
            }
            const coords = ol.proj.fromLonLat([lng, lat]);
            const marker = new ol.Feature({
                geometry: new ol.geom.Point(coords),
                name: name, // Thuộc tính tên, dùng cho popup
                description: description // Thuộc tính mô tả, dùng cho popup
            });
            markerLayer.getSource().addFeature(marker);
        }

        // Vẽ một tuyến đường trên bản đồ dựa trên danh sách các tọa độ.
        // Hàm này được gọi từ Java.
        // Tham số: coordinatesArray là một mảng các cặp [lng, lat].
        function drawRoute(coordinatesArray) {
            if (!mapInstance || !routeLayer) {
                console.error("Map or route layer not initialized. Cannot draw route.");
                return;
            }
            // Chuyển đổi tất cả tọa độ sang hệ quy chiếu của bản đồ
            const olCoordinates = coordinatesArray.map(coord => ol.proj.fromLonLat(coord));
            
            const routeFeature = new ol.Feature({
                geometry: new ol.geom.LineString(olCoordinates)
            });
            routeLayer.getSource().clear(); // Xóa tuyến đường cũ (nếu có)
            routeLayer.getSource().addFeature(routeFeature);
        }

        // Xóa tất cả các điểm đánh dấu (marker) khỏi bản đồ.
        // Hàm này được gọi từ Java.
        function clearAllMarkers() {
            if (markerLayer) {
                markerLayer.getSource().clear();
                if (popupOverlay) {
                    popupOverlay.setPosition(undefined); // Ẩn popup nếu đang mở
                }
            }
        }

        // Xóa tuyến đường hiện tại khỏi bản đồ.
        // Hàm này được gọi từ Java.
        function clearRoute() {
            if (routeLayer) {
                routeLayer.getSource().clear();
            }
        }

        // Di chuyển (pan) bản đồ tới một tọa độ cụ thể.
        // Hàm này được gọi từ Java.
        // Tham số: lng (kinh độ), lat (vĩ độ).
        function panTo(lng, lat) {
            if (mapInstance) {
                const centerCoords = ol.proj.fromLonLat([lng, lat]);
                mapInstance.getView().animate({ // Tạo hiệu ứng di chuyển mượt
                    center: centerCoords,
                    duration: 1000 // Thời gian animation (ms)
                });
            }
        }

        // Hàm này có thể được gọi từ Java để kiểm tra xem bản đồ đã sẵn sàng chưa
        // hoặc để kích hoạt các hành động khác sau khi script này đã được tải hoàn toàn.
        function isMapScriptReady() {
            console.log("map.html: isMapScriptReady called by Java.");
            return true;
        }

    </script>
</body>
</html>